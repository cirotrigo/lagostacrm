{
  "name": "[Coronel Picanha] Deal Stage Label Sync",
  "nodes": [
    {
      "parameters": {
        "content": "## Webhook - Deal Stage Changed\n\nRecebe eventos deal.stage_changed do trigger PostgreSQL via integration_outbound_endpoints",
        "height": 200,
        "width": 280
      },
      "id": "sticky-webhook",
      "name": "Sticky Note Webhook",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -400,
        80
      ]
    },
    {
      "parameters": {
        "content": "## Sincronizacao de Labels\n\nQuando um deal muda de etapa no CRM:\n1. Extrai dados do webhook\n2. Busca chats existentes para encontrar o LID do contato\n3. Busca labels existentes no WhatsApp\n4. Encontra a label correspondente pelo nome\n5. Aplica label via WPPConnect API usando o LID\n\nPRE-REQUISITO: Labels devem existir no WhatsApp Business!\nCriar manualmente: Nova Interacao, Em Atendimento, Aguardando Cliente, Info Fornecidas, Canal Oficial, Finalizado\n\nIMPORTANTE: O WPPConnect usa formato @lid (Linked ID) para labels, nao @c.us",
        "height": 360,
        "width": 400,
        "color": 4
      },
      "id": "sticky-info",
      "name": "Sticky Note Info",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -400,
        -280
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "deal-stage-label-sync",
        "options": {
          "responseMode": "onReceived"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -320,
        240
      ],
      "id": "webhook-deal-stage",
      "name": "Webhook_Deal_Stage_Changed",
      "webhookId": "deal-stage-label-sync"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "contact-phone",
              "name": "contact_phone",
              "type": "string",
              "value": "={{ $json.body?.contact?.phone || $json.contact?.phone || '' }}"
            },
            {
              "id": "contact-phone-normalized",
              "name": "contact_phone_normalized",
              "type": "string",
              "value": "={{ ($json.body?.contact?.phone || $json.contact?.phone || '').replace(/^\\+/, '').replace(/[^0-9]/g, '') }}"
            },
            {
              "id": "to-stage-label",
              "name": "to_stage_label",
              "type": "string",
              "value": "={{ $json.body?.deal?.to_stage_label || $json.deal?.to_stage_label || '' }}"
            },
            {
              "id": "from-stage-label",
              "name": "from_stage_label",
              "type": "string",
              "value": "={{ $json.body?.deal?.from_stage_label || $json.deal?.from_stage_label || '' }}"
            },
            {
              "id": "deal-id",
              "name": "deal_id",
              "type": "string",
              "value": "={{ $json.body?.deal?.id || $json.deal?.id || '' }}"
            },
            {
              "id": "deal-title",
              "name": "deal_title",
              "type": "string",
              "value": "={{ $json.body?.deal?.title || $json.deal?.title || '' }}"
            },
            {
              "id": "contact-name",
              "name": "contact_name",
              "type": "string",
              "value": "={{ $json.body?.contact?.name || $json.contact?.name || '' }}"
            },
            {
              "id": "wpp-host",
              "name": "WPP_Host",
              "type": "string",
              "value": "https://coronel-wwp.lagostacriativa.com.br"
            },
            {
              "id": "wpp-session",
              "name": "WPP_Session",
              "type": "string",
              "value": "lagostacrm"
            }
          ]
        },
        "options": {}
      },
      "id": "extrair-dados",
      "name": "Extrair_Dados",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -80,
        240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "has-phone",
              "leftValue": "={{ $json.contact_phone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "has-stage",
              "leftValue": "={{ $json.to_stage_label }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "validar-dados",
      "name": "Dados_Validos?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        160,
        240
      ]
    },
    {
      "parameters": {
        "url": "={{ $('Extrair_Dados').item.json.WPP_Host }}/api/{{ $('Extrair_Dados').item.json.WPP_Session }}/all-chats",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "timeout": 30000
        }
      },
      "id": "buscar-chats-wpp",
      "name": "Buscar_Chats_WPP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        160
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "fkCh7h3e4c3iHT4J",
          "name": "WPPConnect API"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $('Extrair_Dados').item.json.WPP_Host }}/api/{{ $('Extrair_Dados').item.json.WPP_Session }}/get-all-labels",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "timeout": 15000
        }
      },
      "id": "buscar-labels-wpp",
      "name": "Buscar_Labels_WPP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        640,
        160
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "fkCh7h3e4c3iHT4J",
          "name": "WPPConnect API"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Busca o LID do chat e as labels (nova e anterior)\nconst chatsResponse = $('Buscar_Chats_WPP').first().json;\nconst labelsResponse = $input.first().json;\n\nconst chats = chatsResponse?.response || [];\nconst labels = labelsResponse?.response || labelsResponse || [];\n\nconst contactPhone = $('Extrair_Dados').item.json.contact_phone_normalized;\nconst toStageLabel = $('Extrair_Dados').item.json.to_stage_label;\nconst fromStageLabel = $('Extrair_Dados').item.json.from_stage_label;\n\n// Mapeamento de nomes do CRM para labels do WhatsApp\nconst stageLabelMap = {\n  'Nova Interação': 'Nova Interacao',\n  'Informacoes Fornecidas': 'Info Fornecidas',\n  'Informações Fornecidas': 'Info Fornecidas',\n  'Direcionado para Canal Oficial': 'Canal Oficial'\n};\n\n// Funcao para buscar label pelo nome\nfunction findLabel(stageName) {\n  if (!stageName) return null;\n  const labelName = stageLabelMap[stageName] || stageName;\n  return Array.isArray(labels) \n    ? labels.find(label => {\n        const lname = label.name?.toLowerCase();\n        return lname === labelName.toLowerCase() || \n               lname === stageName.toLowerCase();\n      })\n    : null;\n}\n\n// Busca label da nova etapa\nconst newLabelName = stageLabelMap[toStageLabel] || toStageLabel;\nconst foundNewLabel = findLabel(toStageLabel);\n\n// Busca label da etapa anterior (para remover)\nconst oldLabelName = stageLabelMap[fromStageLabel] || fromStageLabel;\nconst foundOldLabel = findLabel(fromStageLabel);\n\n// Procura o chat pelo numero de telefone\nlet chatLid = null;\nlet chatFound = false;\n\nif (Array.isArray(chats) && contactPhone) {\n  for (const chat of chats) {\n    const chatStr = JSON.stringify(chat);\n    if (chatStr.includes(contactPhone)) {\n      chatLid = chat.id?._serialized || null;\n      chatFound = true;\n      break;\n    }\n    const shortPhone = contactPhone.slice(-11);\n    if (shortPhone.length >= 8 && chatStr.includes(shortPhone)) {\n      chatLid = chat.id?._serialized || null;\n      chatFound = true;\n      break;\n    }\n  }\n}\n\n// Se nao encontrou pelo telefone, tenta pelo nome\nif (!chatFound && $('Extrair_Dados').item.json.contact_name) {\n  const contactName = $('Extrair_Dados').item.json.contact_name.toLowerCase();\n  for (const chat of chats) {\n    const chatName = (chat.contact?.name || chat.contact?.pushname || '').toLowerCase();\n    if (chatName && chatName.includes(contactName)) {\n      chatLid = chat.id?._serialized || null;\n      chatFound = true;\n      break;\n    }\n  }\n}\n\n// Monta o array de options para a API\nconst labelOptions = [];\n\n// Se tem label antiga, adiciona operacao de remocao primeiro\nif (foundOldLabel) {\n  labelOptions.push({ labelId: String(foundOldLabel.id), type: 'remove' });\n}\n\n// Adiciona operacao de adicionar nova label\nif (foundNewLabel) {\n  labelOptions.push({ labelId: String(foundNewLabel.id), type: 'add' });\n}\n\nif (foundNewLabel && chatFound && chatLid) {\n  return [{ json: {\n    newLabelId: String(foundNewLabel.id),\n    newLabelName: foundNewLabel.name,\n    oldLabelId: foundOldLabel ? String(foundOldLabel.id) : null,\n    oldLabelName: foundOldLabel ? foundOldLabel.name : null,\n    labelOptions: labelOptions,\n    labelFound: true,\n    chatLid: chatLid,\n    chatFound: true,\n    contactPhone: contactPhone\n  }}];\n} else if (!foundNewLabel) {\n  return [{ json: {\n    newLabelId: '',\n    newLabelName: newLabelName,\n    oldLabelId: null,\n    oldLabelName: null,\n    labelOptions: [],\n    labelFound: false,\n    chatLid: chatLid,\n    chatFound: chatFound,\n    contactPhone: contactPhone,\n    error: `Label '${newLabelName}' nao encontrada no WhatsApp. Crie manualmente.`\n  }}];\n} else {\n  return [{ json: {\n    newLabelId: String(foundNewLabel.id),\n    newLabelName: foundNewLabel.name,\n    oldLabelId: null,\n    oldLabelName: null,\n    labelOptions: [],\n    labelFound: true,\n    chatLid: null,\n    chatFound: false,\n    contactPhone: contactPhone,\n    error: `Chat nao encontrado para telefone ${contactPhone}. O contato precisa ter uma conversa previa no WhatsApp.`\n  }}];\n}"
      },
      "id": "encontrar-label-e-chat",
      "name": "Encontrar_Label_e_Chat",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        160
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "label-found",
              "leftValue": "={{ $json.labelFound }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "chat-found",
              "leftValue": "={{ $json.chatFound }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "label-e-chat-ok",
      "name": "Label_e_Chat_OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        1120,
        160
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Extrair_Dados').item.json.WPP_Host }}/api/{{ $('Extrair_Dados').item.json.WPP_Session }}/add-or-remove-label",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ chatIds: [$json.chatLid], options: $json.labelOptions }) }}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "aplicar-label-wpp",
      "name": "Aplicar_Label_WPP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        80
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "fkCh7h3e4c3iHT4J",
          "name": "WPPConnect API"
        }
      },
      "continueOnFail": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "success",
              "leftValue": "={{ $json.status === 'success' || $json.response?.status === 'success' || $json.status === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "resultado",
      "name": "Aplicacao_OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        1600,
        80
      ]
    },
    {
      "parameters": {
        "content": "## Sucesso\n\nLabel aplicada com sucesso no chat do WhatsApp usando o LID correto",
        "height": 120,
        "width": 240,
        "color": 3
      },
      "id": "sticky-sucesso",
      "name": "Sticky Note Sucesso",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1840,
        -20
      ]
    },
    {
      "parameters": {},
      "id": "fim-sucesso",
      "name": "Fim_Sucesso",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1920,
        20
      ]
    },
    {
      "parameters": {
        "content": "## Erro na Aplicacao\n\nFalha ao aplicar label - verifique logs",
        "height": 120,
        "width": 280,
        "color": 7
      },
      "id": "sticky-erro-aplicacao",
      "name": "Sticky Note Erro Aplicacao",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1840,
        140
      ]
    },
    {
      "parameters": {},
      "id": "fim-erro-aplicacao",
      "name": "Fim_Erro_Aplicacao",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1920,
        180
      ]
    },
    {
      "parameters": {
        "content": "## Label ou Chat Nao Encontrado\n\n- Label nao existe no WhatsApp: Crie manualmente\n- Chat nao encontrado: Contato precisa ter conversa previa no WhatsApp",
        "height": 160,
        "width": 340,
        "color": 6
      },
      "id": "sticky-nao-encontrado",
      "name": "Sticky Note Nao Encontrado",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1320,
        200
      ]
    },
    {
      "parameters": {},
      "id": "fim-nao-encontrado",
      "name": "Fim_Nao_Encontrado",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1440,
        240
      ]
    },
    {
      "parameters": {},
      "id": "fim-dados-invalidos",
      "name": "Fim_Dados_Invalidos",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        400,
        320
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook_Deal_Stage_Changed": {
      "main": [
        [
          {
            "node": "Extrair_Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair_Dados": {
      "main": [
        [
          {
            "node": "Dados_Validos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados_Validos?": {
      "main": [
        [
          {
            "node": "Buscar_Chats_WPP",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fim_Dados_Invalidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_Chats_WPP": {
      "main": [
        [
          {
            "node": "Buscar_Labels_WPP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_Labels_WPP": {
      "main": [
        [
          {
            "node": "Encontrar_Label_e_Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Encontrar_Label_e_Chat": {
      "main": [
        [
          {
            "node": "Label_e_Chat_OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Label_e_Chat_OK?": {
      "main": [
        [
          {
            "node": "Aplicar_Label_WPP",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fim_Nao_Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar_Label_WPP": {
      "main": [
        [
          {
            "node": "Aplicacao_OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicacao_OK?": {
      "main": [
        [
          {
            "node": "Fim_Sucesso",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fim_Erro_Aplicacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "40a4bf98421ceaa680c1d7554ed416ede6bd8f87784b3bf1a48d585f53d276c2"
  },
  "tags": []
}
